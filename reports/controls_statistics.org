
#+TITLE: Controls Statistics
#+AUTHOR: Gun Woo Park

* Preface

* Stochastic Steps (previous version)
Number of chains per beads, $Nc$, normalized length for end-capping, $l_c$.
** Visiting random beads
The visit probability is identical: that means we visit particles with probability $1/Np$, where $Np$ is number of particles. 

** Selecting chains
Each chains has probability that depends on the tension exerted on the chains:
\begin{equation}
P'(\mathbf{r}_i, \mathbf{r}_j) = \beta_0\exp\left((k_BT)^{-1}F(\mathbf{r}_i, \mathbf{r}_j)l_c\right),
\end{equation}
where $\beta_0$ is given parameters that related with detachment frequency:
\begin{equation}
\beta_0 = \Omega \exp(-E_B/k_BT),
\end{equation}
which depth of energy wall, $E_B$, controls that chain keeps the attached state.

The suggested probability is normalized by partition function for visited beads, $Z_k$:
\begin{equation}
Z_k = \sum_{i=1}^{N_{ce}}\beta_0\exp\left((k_BT)^{-1}F(\mathbf{r}_i, \mathbf{r}_{\mathscr{C}_k(\mathbf{r}_i)})l_c\right),
\end{equation}
where $\mathscr{C}_k(\mathbf{r}_i)$ is the position vectors for other chain ends of $\mathbf{r}_i$.


# Note that the barrier energy $E_B$ affect to $\beta_0$ which is canceled out since this is constant variables both of denominator and numerator. So, the normalized probability is NOT affected by the barrier energy.



** Action of selected chain ends
At the moment, the behaviour for selected chain ends follows Boltzmann distribution of the potential exerted on the chain:
\begin{equation}
p_k(\mathbf{r}_i, \mathbf{r}_j) = \exp\left(-(k_BT)^{-1}U(\mathbf{r}_i, \mathbf{r}_j)\right),
\end{equation}
where $U$ is potential exerted on the chains which is function of the distance between each chain ends, $|\mathbf{r}_j - \mathbf{r}_i|$.

* Stochastic Steps (revised version)
The proposed scheme using normalized probability distribution with $Z_k$ that cancels out the effect of energy barrier. On this regards, there is no role from it which results in increasing flux to association. In addition, the visiting the chain ends that has the highest energy more frequently while the visiting opportunity to other chains becomes lower and lower. 

** Selecting subjected chain end
Let assumed that the selecting chain ends is in random, i.e., we are specifying the visiting chain ends as 
\begin{equation}
P_{i,k} = \frac{1}{2*Nc*Np}.
\end{equation}
** Transition state: Active or Passive
In any visiting state, we have to decide the subjected chain end is in transition state or not. The meaning of chain end is in transition state is that it detached from previously attached bead, and waiting decision for next action. Let 'active' be the transition state while 'passive' be the remained state. 

*** Roof chain 
Consider the selected chain end attached the same bead with the opposite side of chain ends, which is called roof chain. In this case, the transition probability from passive to active is controlled by energy barrier to detachment, $E_B$. Let assumed that transition probability is given by Boltzmann factor:
\begin{equation}
\pi_{P\to A} \equiv \frac{\exp\left(-(k_BT)^{-1}E_B\right)}{\exp(0)} = \exp\left(-(k_BT)^{-1}E_B\right) (\equiv \tilde{\beta}_0)
\end{equation}

*** Associated chain
If the subject chain ends is associate state, i.e., opposite side of chain end attached to other beads, the tension exerted on the chain help to transition from passive to active state. With the same notation for the detachment frequency, we have
\begin{equation}
\pi_{P\to A} = \exp\left(-(k_BT)^{-1}\left(E_B - Fl_c\right)\right) (\equiv \tilde{\beta} = \tilde{\beta}_0\exp(Fl)),
\end{equation}
where $F$ is tension exerted on the chain and $l_c$ is length for end-capping.

*** Metropolis Algorithm
Notice that whenever $Fl_c$ larger than $E_B$, the transition probability higher than unity. Similar to the Metropolis algorithm, we are applying always acceptance state for the transition:
\begin{equation}
\pi_{P\to A} = \left\{ \begin{array}{cc} \exp\left(-(k_BT)^{-1}\left(E_B - Fl_c\right)\right), & E_B > Fl_c \\
1, & \textrm{otherwise} \end{array}\right.
\end{equation}
** Action of selected chain ends
Following the previous scheme.

* The differences with the previous version 
Even if the physical meaning differ from the previous version, the consequence of probability map is not so much changes. The flux to detachment, however, is controlled by energy barrier, $E_B$, it is expected that the flux to detach for roof chain decreases while the flux to detach for associated chain increases. In consequence, energy barrier is no more ignorance variable, which is differ from the previous version since the normalized selecting probability in previous version canceled out the energy barrier effect. 

For better understanding, let assumed there are only one chain is associated for given bead while the other chains (say 9) are roof, the probability for the previous map is given by
\begin{equation}
P_{old, i(association)} = \frac{\exp(Fl_c)}{9 + \exp(Fl_c)}.
\end{equation}
When we have cumulating $P_{old}$ in terms of index, we have the maps for selecting probability. 
Even if we do not think about this way, this scheme is physically the same with that /we are visiting chain with equal-probable, and have transition probability from passive to active state with $P_{old}$/. In this sense, the probability to select chain (that automatically in active state) follows figure [[fig:selection_probability]].

In the revised version with Metropolis algorithm, this is not the case. The meaning will be similar with the previous sentence but have different probability:
\begin{equation}
P_{i(association)} = \pi_{P\to A},
\end{equation}
which shows figure [[fig:transition_probability]] as example. Notice that the meaning for the figure [[fig:selection_probability]] and [[fig:transition_probability]] is different.

* Simplified analysis for flux balance
First of all, this analysis is simplified version to ignore concurrent flux details in order to ignore complicate bridge maps. In addition, the number of allowance per beads is totally ignored for this analysis in order to make Markov chain diagram. For convenience, all the tilde is omitted for non-dimensional variables.

The analysis on here is described on figure [[fig:simplified_diagram]] for both of bridge and roof chain.

** Simplified roof chain
# Let assumed that there is $N_p$ beads and all the chains in the beads are /roof state/. 
Consider a chain that attached on k-th bead, and the probability maps for the transition state is given by
\begin{equation}
\pi^{k}_{P\to A} = \exp(-E_B),
\end{equation}
since it is roof state, which implies that the probability that the chain end is passive state is automatically $q - \pi^{k}_{P\to A}$.
Once it is in active state (transition state), the probability to take action is following the rule:
\begin{equation}
P'_{i,k} = \exp(-U_{i,k}),
\end{equation}
where $U_{i,k}$ is the expected potential if the chain connecting between i-th and k-th beads. Since we assumed that attachment can happen with any beads (without restriction of number of allowance) in this analysis, the normalized probability becomes
\begin{equation}
P_{i,k} = \frac{\exp(-U_{i,k})}{Z^{U}_{k}}\qquad\textrm{with }Z^{U}_{k} = \sum_{j=1}^{N_p}\exp(-U_{j,k}).
\end{equation}
Because of potential for the roof chain becomes zero, we have probability to way back to the original roof chain as $1/Z^{U}_{k}$ while the probability to attach beads except its original beads (k-th beads) becomes $(Z^{U}_k - 1)/Z^{U}_k$.
Therefore, we can compute the flux to remain roof chain:
\begin{align}
\pi_{roof \to roof} &= \left(1 - \pi^{k}_{P\to A}\right) + \pi^{k}_{P\to A}\cdot \frac{1}{Z^{U}_k}\\
&= 1 - \left(1 - \frac{1}{Z^{U}_k}\right)\exp(-E_B),
\end{align}
while the flux to make bridge:
\begin{align}
\pi_{roof \to bridge} &=\pi^{k}_{P\to A}\cdot\frac{Z^{U}_k -1}{Z^{U}_k}\\
&= \frac{Z^{U}_k -1}{Z^{U}_k}\exp(-E_B).
\end{align}

*** Extreme case: $Z^{U}_k \approx N_p$
This assumption is very extreme since it only happens when the all the particles are close to each other. In this sense, the approximated fluxes become
\begin{align}
\pi_{roof\to roof}&\approx 1 - \exp(-E_B) \\
\pi_{roof\to bridge} &\approx \exp(-E_B),
\end{align}
which means the flux balance is directly controlled by energy barrier.

*** Realistic case with equilibrium results of NC25 in the previous method
Here, tracking equilibrium trajectory is very complicate to analysis. For this reason, I have used coordination number with its peak distance of the equilibrium results of the previous method. Since the result has densely aggregated between particles, we can understand the flux dependencies for this case.

For Gaussian connector, we have potential
\begin{equation}
U(\mathbf{r}_i, \mathbf{r}_j) = \frac{N_D}{2}\mathbf{r}^2_{ij},
\end{equation}
which means we have unity pre-factor for 2-dimensional system. 
Then, the approximated partition function becomes
\begin{equation}
Z^{U}_{k} \approx 1 + CN_1\exp(-r_{p,1}^2) + CN_2\exp(-r_{p,2}^2) + CN_3\exp(-r_{p,3}^2) + residue(n>3),
\end{equation}
where $CN_n$ is n-th coordination number and $r_{p,n}$ is the distance for the n-th peak, and residue is effect for outside the third sell. This is quite valid since $r_{p,3} =  2.52$ and $CN_3$ is computed up to 3.07 in dimensionless distance. Note that $\exp(-3.07^2) \approx 8.07\times 10^{-5}$ which means even if we have all the 640-1 bead is outside of this distance, the effect becomes 0.05 which is quite minor. From this approximation, we can compute
\begin{equation}
Z^{U}_{k} \approx 1+ 4.33\exp(-0.94^2) + 5.65\exp(-1.67^2) + 5.33\exp(-2.52^2) \approx 3.147.
\end{equation}
In this case, we have the approximated flux as
\begin{align}
\pi_{roof\to roof} &\approx 1 - \left(1 - \frac{1}{3.147}\right)\exp(-E_B) = 1 - 0.68\exp(-E_B),\\
\pi_{roof\to bridge} &\approx 0.68\exp(-E_B).
\end{align}



** Simplified bridge chain
# Let assumed that the all chains are roof state except the only one chain is bridge between j-th and k-th beads.Let 
Consider our visited chain end is attached to k-th bead and the opposite side of chain end attached to j-th bead. Let say the chain ends number is $c_n$ on this specific chain ends. Similar with the previous approach, but here the chains are distinguishable between bridge and roof. Therefore, we have different transition probability:
\begin{equation}
\pi^{k,c_n}_{P\to A} = \min\left\{1, \exp(F_{j,k}l - E_B)\right\}.
\end{equation}
In this example, making roof chain is no more remaining state, but it should be in transition state then attached to the beads that also attached the other chain ends of selected chain. Therefore, we have flux to make roof:
\begin{align}
\pi_{bridge\to roof} &= \pi^{k,c_n}_{P \to A}\cdot \frac{1}{Z^{U}_{j}}\\
&=\min\left\{1, \exp(F_{j,k}l - E_B)\right\}\frac{1}{Z^{U}_j}.
\end{align}
Note that the partition function is $Z^{U}_j$.
The flux to make bridge is summation between remaining flux and transition*bridge:
\begin{align}
\pi_{bridge\to bridge} &= \left(1 - \pi^{k,c_n}_{P\to A}\right) + \pi^{k, c_n}_{P
\to A}\cdot \frac{Z^{U}_j -1}{Z^{U}_j}\\
&= 1 - \left(1 - \frac{Z^{U}_j - 1}{Z^{U}_j}\right)\min\left\{\exp(F_{j,k}l - E_B)\right\}.
\end{align}

# In this case, all the particles 
***** Extreme case: $Z^{U}_k \approx N_p$

Similar with the previous example, we can use approximation. Note that the maximum values for $\pi^{k,c_n}_{P\to A}$ is 1, the ratio between transition probability and partition function for action becomes negligible when $N_p$ is large. In this sense, we have fluxes:
\begin{align}
\pi_{bridge\to roof} &\approx 0 \\
\pi_{bridge\to bridge} &\approx 1,
\end{align}
which means it tends to association whenever bridge chain happens.

***** Realistic case with equilibrium results of NC25 in the previous method
Again, we are using $Z^{U}_j\approx 3.147$ since the coordination number is computed by RDF that is already averaged value. In averaged manner, here we assumed that $Z^{U}_j \approx Z^{U}_k$. With this assumption, we have fluxes:
\begin{align}
\pi_{bridge\to roof} &\approx 0.318\min\left\{1, \exp(F_{j,k}l - E_B)\right\}\\
\pi_{bridge\to bridge} &\approx 1 - 0.318\min\left\{1, \exp(F_{j,k}l - E_B)\right\}.
\end{align}
So the prefactor 0.318 controls the flux balance between roof and bridge from chains in bridge state. 

** Combining two examples
First of all, it would be notice that the previous analysis is removed the restrictions of number of allowance in order to remove historical dependence (non-Markovian behaviour). In my point of view, if the number of allowance has real effect rather than accelerator or stabilizer, then the stochastic step is in cage state, which might be wrong. From previous analysis for flux balance, *we can expect that it is possible to transition /roof to bridge/, but it is very rare and almost impossible to transition /bridge to roof/*. This can be understood in the way that /roof to bridge/ is controlled by introduced energy barrier $E_B$, but once we overcome this energy barrier - with high number of stochastic trials -, the way back to roof state is relatively small if we compare it with way to make bridge. In addition, the used values for this results have lowerly aggregated, that means the value 3.147 becomes larger when we have data with new results. In this sense, the prefactor for bridge 0.318 can be regarded as higher value than the reality which means the probability to becomes roof is more difficult in comparison with the probability to bridge. 

The energy barrier seems to works both of chains in roof state and bridge state, but effect is minor at this moment since the flux are highly controlled by the averaged partition function for potential. *It strongly suggested that the probability for taking action is /under-estimated/*, which means $\exp(-U_{i,j})$ is not enough for the determination of attachment.


# from roof state to bridge state is controlled by energy barrier. However, once we have probability that allow bridge, the way back from bridge status to roof status is very rare (approximately zero). This strongly suggested that the proposed kinetics should be re-builded rather than minor chain for transition probability.
# **** Connectivity Information

# First of all, the following description is related with generalization the transition probability matrix with newly developed scheme. However, the internal information change effect to the system, which means the it cannot be the independent probability that handling components-wise in the matrix form. At this moment, the basic approach will following the previously described manner with the existing stochastic method. Even if the following description will not applied at this moment, it is worth to develop transition probability that describe the whole information for association/dissociation kinetics. 

# Let $\mathscr{C}_{i,j}$ be the number of connections between i-th and j-th particles, the connectivity matrix is given by 
# \begin{equation}
# \mathbf{C} = \left[\mathscr{C}_{i, j}\right]\qquad i,\,j\in [1, N_p].
# \end{equation}
# Let $\pi_{i,j}$ be transition probability to connect between i-th and j-th particle:
# \begin{equation}
# \pi_{i,j} = \pi^{i}_{P\to A}P_{i,j},
# \end{equation}
# where $\pi^{i}_{P\to A}$ is transition probability from passive to active for i-th particle and $P_{i,j}$ is action probability between i-th and j-th particle.
# On this regards, we can define transition matrix
# \begin{equation}
# \boldsymbol{\Pi} = \left[\pi_{i,j}\right]\qquad i,\,j\in [1, N_p]
# \end{equation}





* Results of revised method
In conclusion, there is no significant from energy barrier to the flux balance between association and dissociation. The results are described on the figure [[fig:effect_energy_barrier]], which shows that three distinguishable regime: (i) initially decreasing, (ii) plateau region, and (iii) decreasing further. Increasing number of trial, however, reveals that the (iii) region is artificial and the number of associations in the (iii) will reach the values of plateau region (ii). This strongly suggested that if we have number of trials, we have just two regions: (i) initially decreasing and (ii) plateau region, which seems to be stationary state. The consequence of increasing number of trials is shown in [[fig:effect_energy_barrier_METROPOLIS]]. (For this aspect, we need for /important sampling/ technique to reduce computation time)

The reason that shows the plateau region is not easily understandable, but there is one way to compare based on the previous bridge flux. To make it clear, consider the chain is in roof state, then the energy barrier has role. However, with increasing number of stochastic trials, the number to make bridge is increasing. The importance is that the flux from bridge to roof. If we compute the balance between flux to bridge and flux to roof (from bridge state), the approximated solution shows
\begin{equation}
balance = \frac{\pi_{bridge\to roof}}{\pi_{bridge\to bridge}} = \frac{0.318\min\left\{1, \exp(Fl-E_B)\right\}}{1-0.318\min\left\{1, \exp(Fl-E_B)\right\}}.
\end{equation}
For given Fl with $\exp(Fl-E_B)$,
\begin{equation}
balance \approx \frac{0.318\exp(Fl)}{exp(E_B) - 0.318\exp(Fl)},
\end{equation}
note that the sign for $E_B$ is positive. Since $\exp(Fl)$ is constant, the given balance approximately exponential decay with respect to $E_B$, which means the effect with larger $E_B$ is quite minor in this balance.

# ** Reason for the poor statistics for the region (iii)
# This is due to the fact that Metropolis algorithm is NOT efficiency to go through the energy barrier. This is frequently happens in many Monte Carlo simulations. In this case, /important sampling/ is needed to have unbiased statistics. For better understand, see the flux analysis section.

# ** Reason for decreasing number of associations for the region (i)
# Based on our analysis for the flux, it can be understood that the 

# ** Explanations for the similar stationary values between energy barrier scheme and previously used methods
# In principle, the energy barrier is just way to determine it is active or not. Number of association is the consequence of balance between flux to attach to its originate bead and flux to attach to other bead, which is determined by 


* Figures
** Selection probability in the previous map
#+CAPTION: Example for the selection probability that there is only one associated chain exist while other 9 chains are in roof state.
#+NAME: fig:selection_probability
#+ATTR_HTML: :width 640px
[[file:controls_statistics/chain_selection_probability.png]]

** Transition probability in the revised version
#+CAPTION: Example for the transition probability that has only one association while other 9 chains are remained in roof state.
#+NAME: fig:transition_probability
#+ATTR_HTML: :width 640px
[[file:controls_statistics/transition_probability_revised.png]]

** Results with different energy barrier
#+CAPTION: Energy barrier effect to the statistics. The given data is extracted one time step where the initial position is given by equilibration without associations. The red dashed line refers the original scheme while blue symbols are energy barrier scheme.
#+NAME: fig:effect_energy_barrier
#+ATTR_HTML: :width 640px
[[file:controls_statistics/effect_energy_barrier.png]]

#+CAPTION: Recomputed roof and bridge with the previous figure
#+NAME: fig:effect_energy_barrier_METROPOLIS
#+ATTR_HTML: :width 640px
[[file:controls_statistics/poor_statistics_METROPOLIS.png]]


** Flux analysis when every chains are roof
#+CAPTION: Simplified diagram for flux analysis
#+NAME: fig:simplified_diagram
#+ATTR_HTML: :width 760px
[[file:controls_statistics/simplified_diagram.png]]

#+CAPTION: Balance between roof and bridge when there are 640 beads with all the chains are in roof state.
#+NAME: fig:balance_flux_loglog
#+ATTR_HTML: :width 640px
[[file:controls_statistics/ratio_flux_loglog.png]]


# # * Temp
# # \begin{equation}
# # \exp(-\tilde{E}_B)
# # \end{equation}
# # \begin{equation}
# # 1 - \exp(-\tilde{E}_B)
# # \end{equation}

# \begin{equation}
# Z_j = \sum_{i = 0 (\neq k)}^{N_p} \exp(-\tilde{U}_{i,j})
# \end{equation}

# \begin{equation}
# \frac{1}{Z_j}
# \end{equation}
# \begin{equation}
# \frac{Z_j -1}{Z_j}
# \end{equation}

# # \begin{equation}
# # 1-\exp(-\tilde{E}_B) + \exp(-\tilde{E}_B)\cdot\frac{1}{Z_k}
# # \end{equation}
# # \begin{equation}
# # \exp(-\tilde{E}_B)\cdot\frac{Z_k-1}{Z_k}
# # \end{equation}

# # \begin{equation}
# # \min\left\{1, \exp(\tilde{F}\tilde{l} - \tilde{E}_B)\right\}
# # \end{equation}

# # \begin{equation}
# # 1-\min\left\{1, \exp(\tilde{F}\tilde{l} - \tilde{E}_B)\right\}
# # \end{equation}

# \begin{equation}
# \exp(\tilde{F}\tilde{l} - \tilde{E}_B) \cdot \frac{1}{Z_j}
# \end{equation}

# \begin{equation}
# 1 - \exp(\tilde{F}\tilde{l} - \tilde{E}_B) + \exp(\tilde{F}\tilde{l} - \tilde{E}_B)\cdot \frac{Z_k - 1}{Z_j}
# \end{equation}
